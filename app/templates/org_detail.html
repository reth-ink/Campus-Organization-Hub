{% extends 'base.html' %}

{% block content %}

<div class="home-layout">

    <!-- LEFT: Org info / officers -->
    <aside class="left-sidebar">
        <div style="display:flex; align-items:center; gap:8px;">
            <h3 style="margin:0;">{{ org.OrgName }}</h3>
            {% if is_admin %}
                <button type="button" id="org-settings-toggle" title="Organization settings" style="border:none;background:transparent;cursor:pointer;font-size:18px; position:relative; z-index:210;" tabindex="0" aria-expanded="false" role="button" onclick="event.stopPropagation();(function(btn){var panel=document.getElementById('org-settings-panel'); if(!panel) return; var isHidden = panel.style.display==='none' || panel.style.display==='' ; panel.style.display = isHidden ? 'block' : 'none'; try{ btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false'); }catch(e){} })(this);">⚙️</button>
            {% endif %}
        </div>
        <p class="muted">{{ org.OrgDescription }}</p>

        <div style="margin-top:12px;">
            <p><strong>Members:</strong> {{ member_count }}</p>
        </div>
        {% if is_admin %}
        <div style="margin-top:10px;">
            <a href="{{ url_for('web.org_admin', org_id=org.OrgID) }}" class="post-button" style="display:inline-block;">Manage Members
                {% if pending_count and pending_count|int > 0 %}
                    <span class="pending-badge" aria-label="{{ pending_count }} pending requests">{{ pending_count }}</span>
                {% endif %}
            </a>
        </div>
        {% endif %}

        <h4 style="margin-top:10px;">Officers</h4>
        {% if officers %}
        <ul>
            {% for officer in officers %}
            <li>{{ officer.user_name }} &mdash; <em>{{ officer.role_name }}</em></li>
            {% endfor %}
        </ul>
        {% else %}
        <p>No officers assigned yet.</p>
        {% endif %}

            <div style="margin-top:14px; display:flex; flex-direction:column; gap:8px;">
                {% if is_officer %}
                    <a href="{{ url_for('web.create_announcement', org_id=org.OrgID) }}" class="post-button">Create Announcement</a>
                    <a href="{{ url_for('web.create_event', org_id=org.OrgID) }}" class="post-button">Create Event</a>
                {% else %}
                    <!-- Show the same interface but disable actions for non-admins/members -->
                    <a class="post-button btn-disabled" title="Only organization admins may post announcements">Create Announcement</a>
                    <a class="post-button btn-disabled" title="Only organization admins may create events">Create Event</a>
                    <div style="font-size:0.9rem;color:#666;margin-top:6px;">You are viewing this organization's page. To participate or get admin privileges, request membership or ask an existing admin to assign roles.</div>
                {% endif %}
            </div>

            <!-- Membership actions -->
            <div style="margin-top:12px;">
                {% if not session.get('user_id') %}
                    <a href="{{ url_for('web.login') }}?next={{ request.path }}" class="event-link">Log in to request membership</a>
                {% else %}
                    {% if user_membership %}
                        {% set status = (user_membership.get('Status') or user_membership.get('status')) %}
                        {% if status and status.lower() == 'approved' %}
                            <div style="color:green; font-weight:600;">You are a member of this organization.</div>
                        {% elif status and status.lower() == 'pending' %}
                            <div style="color:orange; font-weight:600;">Your membership request is pending.</div>
                        {% else %}
                            <form method="post" action="{{ url_for('web.request_join', org_id=org.OrgID) }}">
                                <button type="submit" class="post-button">Request to Join</button>
                            </form>
                        {% endif %}
                    {% else %}
                        <form method="post" action="{{ url_for('web.request_join', org_id=org.OrgID) }}">
                            <button type="submit" class="post-button">Request to Join</button>
                        </form>
                    {% endif %}
                {% endif %}
            </div>

        <div style="margin-top:14px;">
            <a href="{{ url_for('web.home') }}" class="event-link">&larr; Back to Home</a>
        </div>
    </aside>

    {% if is_admin %}
    <!-- Settings panel (hidden by default) -->
    <div id="org-settings-panel" style="display:none; position:fixed; left:20px; top:80px; background:#fff; border:1px solid #ddd; padding:12px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.08); z-index:200; width:320px;">
        <h4 style="margin-top:0;">Organization Settings</h4>
        <form method="post" action="{{ url_for('web.org_update_settings', org_id=org.OrgID) }}">
            <label style="font-size:0.9rem;">Name</label>
            <input type="text" name="org_name" value="{{ org.OrgName }}" style="width:100%;padding:6px;margin:6px 0;" />
            <label style="font-size:0.9rem;">Description</label>
            <textarea name="org_description" style="width:100%;height:80px;padding:6px;margin:6px 0;">{{ org.OrgDescription }}</textarea>
            <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button type="submit" class="post-button">Save</button>
                <button type="button" id="org-settings-cancel" class="post-button">Cancel</button>
            </div>
        </form>
        <hr />
        <form method="post" action="{{ url_for('web.org_delete', org_id=org.OrgID) }}" onsubmit="return confirm('Are you sure you want to delete this organization? This action cannot be undone.')">
            <button type="submit" style="background:#e04747;border:none;color:#fff;padding:8px 10px;border-radius:6px;cursor:pointer;">Delete Organization</button>
        </form>
    </div>
    {% endif %}

    <!-- CENTER: Announcements for this org -->
    <main class="feed">
        <h2 class="section-title">Announcements — {{ org.OrgName }}</h2>

        {% if announcements %}
            {% for ann in announcements %}
            <div class="post-card">
                {% if ann.flair %}
                <span class="post-flair">{{ ann.flair }}</span>
                {% endif %}

                <h3 class="post-title">{{ ann.Title }}</h3>
                <p class="post-body">{{ ann.Content }}</p>
                <div class="post-meta">Posted: {{ ann.DatePosted }}</div>
            </div>
            {% endfor %}
        {% else %}
            <p>No announcements yet for this organization.</p>
        {% endif %}
        
        <h2 class="section-title" style="margin-top:18px;">Events — {{ org.OrgName }}</h2>
        {% if events %}
            {% for ev in events %}
            <div class="post-card">
                <h3 class="post-title"><a href="{{ url_for('web.event_detail', event_id=ev.EventID) }}">{{ ev.EventName }}</a></h3>
                <div class="post-meta">When: {{ ev.EventDate }}</div>
                <p class="post-body">{{ ev.Description }}</p>
            </div>
            {% endfor %}
        {% else %}
            <p>No upcoming events.</p>
        {% endif %}
    </main>

    <!-- RIGHT: Events -->
    <aside class="sidebar">
        <div class="sidebar-box">
            <h3 class="sidebar-title">Upcoming Events</h3>
            <div class="upcoming-panel" style="max-height:260px; overflow:auto; padding:6px; border:1px solid #eee; border-radius:6px;">
            {% if events %}
                {% for ev in events[:5] %}
                <div class="event-item" style="padding:6px; border-bottom:1px solid #f2f2f2;">
                    <a class="event-link" href="{{ url_for('web.event_detail', event_id=ev.EventID) }}">{{ ev.EventName }}</a>
                    <div class="event-time">{{ ev.EventDate }}</div>
                </div>
                {% endfor %}
            {% else %}
                <p>No upcoming events.</p>
            {% endif %}
            </div>
            <div style="margin-top:8px; text-align:center;">
                <a class="event-link" href="{{ url_for('web.events') }}">View all events</a>
            </div>
        </div>
    </aside>

</div>

{% endblock %}

{% if is_admin %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('org-settings-toggle');
    var panel = document.getElementById('org-settings-panel');
    var cancel = document.getElementById('org-settings-cancel');
    if(btn && panel){
        btn.addEventListener('click', function(){
            var isHidden = panel.style.display === 'none' || panel.style.display === '';
            panel.style.display = isHidden ? 'block' : 'none';
            try { btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false'); } catch(e){}
        });
    }
    if(cancel && panel){
        cancel.addEventListener('click', function(){ panel.style.display='none'; try { btn.setAttribute('aria-expanded','false'); } catch(e){} });
    }
    // close when clicking outside
    document.addEventListener('click', function(e){
        if(!panel) return;
        if(e.target === btn || btn.contains(e.target) || panel.contains(e.target)) return;
        panel.style.display = 'none';
    });
});
</script>
{% endif %}
